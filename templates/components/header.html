{% load static %}
<header class="header">
  <div class="hamburger" id="hamburger">
    <i class="fa fa-bars" aria-hidden="true"></i>
  </div>
  <div class="header__logo">
    <a href="{% url 'homepage' %}">
      <img
        id="logoImg"
        src="{% static 'ĩmg/light_logo.png' %}"
        alt="GoHCMC Logo"
        class="header__logo-img" />
    </a>
  </div>
  <nav class="nav">
    <a
      href="{% url 'homepage' %}"
      class="nav-link {% if request.path == '/' %}active{% endif %}">
      <i class="fas fa-house"></i> Home
    </a>
    <a
      href="{% url 'weather' %}"
      class="nav-link {% if '/weather' in request.path %}active{% endif %}">
      <i class="fas fa-cloud-sun"></i> Weather
    </a>
    <a
      href="{% url 'locations' %}"
      class="nav-link {% if '/locations' in request.path %}active{% endif %}">
      <i class="fas fa-map-pin"></i> Locations
    </a>
    <a
      href="{% url 'favourite' %}"
      class="nav-link {% if '/favourite' in request.path %}active{% endif %}">
      <i class="fas fa-heart"></i> Favourite
    </a>
    <a
      href="{% url 'trip' %}"
      class="nav-link {% if '/trip' in request.path %}active{% endif %}">
      <i class="fas fa-map"></i> My Trip
    </a>
  </nav>
  <div class="hamburger-menu" id="hamburgerMenu">
    <div class="hamburger-content">
      <a href="{% url 'homepage' %}" class="hamburger-link">
        <i class="fas fa-house"></i> Home
      </a>
      <a href="{% url 'weather' %}" class="hamburger-link">
        <i class="fas fa-cloud-sun"></i> Weather
      </a>
      <a href="{% url 'locations' %}" class="hamburger-link">
        <i class="fas fa-map-pin"></i> Locations
      </a>
      <a href="{% url 'favourite' %}" class="hamburger-link">
        <i class="fas fa-heart"></i> Favourite
      </a>
      <a href="{% url 'trip' %}" class="hamburger-link">
        <i class="fas fa-map"></i> My Trip
      </a>
    </div>
  </div>
  <div class="header__actions">
    {% include 'components/searchbar.html' %}
    <div class="theme-switch" id="themeSwitch" title="Đổi giao diện">
      <span class="theme-switch__icon" id="themeIcon">
        <i class="fa-solid fa-sun" id="icon-sun"></i>
        <i class="fa-solid fa-moon" id="icon-moon" style="display: none"></i>
      </span>
    </div>
  </div>
  <div class="header__user">
    {% if user.is_authenticated %}
    <button class="user-btn">
      <i class="fa-solid fa-user"></i>
      <span class="header__username">{{ user.get_full_name|default:user.username }}</span>
      <i class="fa-solid fa-chevron-down"></i>
    </button>
    {% else %}
    <a href="/login/"><button class="button button-secondary">Login</button></a>
    <a href="/signup/"><button class="button button-primary">Sign Up</button></a>
    {% endif %}
    <div class="user-icon" id="userIcon">
      <i class="fa-solid fa-user"></i>
    </div>
    <div id="userMenu" class="user-menu">
      {% if user.is_authenticated %}
      <a href="{% url 'logout' %}">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span>Logout</span>
      </a>
      {% else %}
      <a href="/login/">
        <button class="button button-secondary">Login</button>
      </a>
      <a href="/signup/">
        <button class="button button-primary">Sign Up</button>
      </a>
      {% endif %}
    </div>
  </div>
</header>
{% include 'components/loading.html' %}
<script>
  // Theme switch logic
  const themeSwitch = document.getElementById("themeSwitch");
  const themeIconSun = document.getElementById("icon-sun");
  const themeIconMoon = document.getElementById("icon-moon");
  const logoImg = document.getElementById("logoImg");
  const lightLogo = "{% static 'img/light_logo.png' %}";
  const darkLogo = "{% static 'img/dark_logo.png' %}";
  function setTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    logoImg.src = theme === "dark" ? darkLogo : lightLogo;
    if (theme === "dark") {
      themeIconSun.style.display = "none";
      themeIconMoon.style.display = "inline";
      themeSwitch.setAttribute("data-theme", "dark");
    } else {
      themeIconSun.style.display = "inline";
      themeIconMoon.style.display = "none";
      themeSwitch.setAttribute("data-theme", "light");
    }
    localStorage.setItem("theme", theme);
  }
  themeSwitch.onclick = function () {
    const current = document.documentElement.getAttribute("data-theme");
    setTheme(current === "dark" ? "light" : "dark");
  };
  // Load theme from localStorage
  (function () {
    const saved = localStorage.getItem("theme");
    setTheme(saved === "dark" ? "dark" : "light");
  })();

  // User menu dropdown logic
  (function () {
    const userBtn = document.querySelector(".user-btn");
    const userIcon = document.getElementById("userIcon");
    const userMenu = document.getElementById("userMenu");

    function showMenu() {
      userMenu.classList.add("open");
      userMenu.setAttribute("aria-hidden", "false");
    }
    function hideMenu() {
      userMenu.classList.remove("open");
      userMenu.setAttribute("aria-hidden", "true");
    }

    // Attach click event to userBtn if it exists
    if (userBtn) {
      userBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        if (userMenu.classList.contains("open")) {
          hideMenu();
        } else {
          showMenu();
        }
      });
    }

    // Attach click event to userIcon if it exists
    if (userIcon) {
      userIcon.addEventListener("click", function (e) {
        e.stopPropagation();
        if (userMenu.classList.contains("open")) {
          hideMenu();
        } else {
          showMenu();
        }
      });
    }

    document.addEventListener("click", function (e) {
      if (!userMenu.contains(e.target) && (!userBtn || !userBtn.contains(e.target)) && (!userIcon || !userIcon.contains(e.target))) {
        hideMenu();
      }
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") hideMenu();
    });
  })();

  // Hamburger menu logic
  (function () {
    const hamburger = document.getElementById("hamburger");
    const hamburgerMenu = document.getElementById("hamburgerMenu");
    if (!hamburger || !hamburgerMenu) return;

    function showMenu() {
      hamburgerMenu.classList.add("open");
    }
    function hideMenu() {
      hamburgerMenu.classList.remove("open");
    }

    hamburger.addEventListener("click", function (e) {
      e.stopPropagation();
      if (hamburgerMenu.classList.contains("open")) {
        hideMenu();
      } else {
        showMenu();
      }
    });

    // Thêm event cho overlay
    hamburgerMenu.addEventListener("click", function (e) {
      if (!hamburgerMenu.querySelector('.hamburger-content').contains(e.target)) {
        hideMenu();
      }
    });

    document.addEventListener("click", function (e) {
      if (!hamburgerMenu.contains(e.target) && !hamburger.contains(e.target)) {
        hideMenu();
      }
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") hideMenu();
    });
  })();

  // Loading overlay logic for page transitions
  (function () {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (!loadingOverlay) return;

    // Function to show loading
    function showLoading() {
      loadingOverlay.classList.add('show');
    }

    // Function to hide loading
    function hideLoading() {
      loadingOverlay.classList.remove('show');
    }

    // Add click listeners to navigation links and buttons
    const navLinks = document.querySelectorAll('.nav-link, .hamburger-link');
    const userButtons = document.querySelectorAll('.header__user a button, .user-menu a, .user-menu button');

    navLinks.forEach(link => {
      link.addEventListener('click', showLoading);
    });

    userButtons.forEach(button => {
      button.addEventListener('click', showLoading);
    });

    // Hide loading after page loads
    window.addEventListener('load', hideLoading);
  })();
</script>

